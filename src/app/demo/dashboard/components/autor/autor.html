<div class="container mx-auto px-4 py-6">
  <!-- Toast para notificaciones -->
  <p-toast></p-toast>

  <!-- Confirm Dialog -->
  <p-confirmDialog></p-confirmDialog>

  <!-- Header -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Autores</h1>
      <p class="text-gray-600">Administra el registro de autores</p>
    </div>
    <p-button label="Nuevo Autor" icon="pi pi-plus" (onClick)="initNewAutor()" severity="primary">
    </p-button>
  </div>

  <!-- Search Bar -->
  <div class="mb-6">
    <span class="p-input-icon-left w-full max-w-md">
      <i class="pi pi-search"></i>
      <input type="text" pInputText [(ngModel)]="searchTerm" (input)="filterAutores()" placeholder="Buscar autores..."
        class="w-full" />
    </span>
  </div>

  <!-- Autores Table -->
  <p-table [value]="filteredAutores" [loading]="isLoading" [paginator]="true" [rows]="10" [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} autores" [rowsPerPageOptions]="[10, 25, 50]"
    styleClass="p-datatable-gridlines">

    <ng-template pTemplate="header">
      <tr>
        <th>Nombre</th>
        <th>Ocupación</th>
        <th>Fecha de Registro</th>
        <th style="width: 150px">Acciones</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-autor>
      <tr>
        <td>
          <div class="flex items-center gap-3">
            <p-avatar *ngIf="autor.foto_url" [image]="autor.foto_url" shape="circle" size="large">
            </p-avatar>
            <p-avatar *ngIf="!autor.foto_url" [label]="getInitials(autor.nombre, autor.apellido)" shape="circle"
              size="large" [style]="{'background-color': '#3b82f6', 'color': '#ffffff'}">
            </p-avatar>
            <div>
              <div class="font-medium text-gray-900">{{ autor.nombre }} {{ autor.apellido }}</div>
            </div>
          </div>
        </td>
        <td>{{ autor.ocupacion || 'Sin especificar' }}</td>
        <td>{{ formatDate(autor.created_at) }}</td>
        <td>
          <div class="flex gap-2">
            <p-button icon="pi pi-pencil" (onClick)="editAutor(autor)" [text]="true" severity="info" [rounded]="true">
            </p-button>
            <p-button icon="pi pi-trash" (onClick)="autor.id && deleteAutor(autor.id)" [text]="true" severity="danger"
              [rounded]="true">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="4" class="text-center py-8">
          <div class="flex flex-col items-center justify-center text-gray-500">
            <i class="pi pi-users text-6xl mb-4 text-gray-400"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No se encontraron autores</h3>
            <p class="text-sm text-gray-500 mb-4">
              {{ searchTerm ? 'No hay coincidencias con tu búsqueda.' : 'Comienza agregando un nuevo autor.' }}
            </p>
            <p-button *ngIf="!searchTerm" label="Nuevo Autor" icon="pi pi-plus" (onClick)="initNewAutor()"
              severity="primary">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Add/Edit Autor Dialog -->
  <p-dialog [(visible)]="showAddForm" [header]="selectedAutor ? 'Editar Autor' : 'Nuevo Autor'" [modal]="true"
    [style]="{width: '500px'}" [draggable]="false" [resizable]="false">

    <form (ngSubmit)="saveAutor()" class="space-y-4">
      <div class="field">
        <label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">
          Nombre <span class="text-red-500">*</span>
        </label>
        <input type="text" id="nombre" pInputText [(ngModel)]="newAutor.nombre" name="nombre" required class="w-full" />
      </div>

      <div class="field">
        <label for="apellido" class="block text-sm font-medium text-gray-700 mb-2">
          Apellido <span class="text-red-500">*</span>
        </label>
        <input type="text" id="apellido" pInputText [(ngModel)]="newAutor.apellido" name="apellido" required
          class="w-full" />
      </div>

      <div class="field">
        <label for="ocupacion" class="block text-sm font-medium text-gray-700 mb-2">
          Ocupación
        </label>
        <input type="text" id="ocupacion" pInputText [(ngModel)]="newAutor.ocupacion" name="ocupacion" class="w-full" />
      </div>

      <div class="field">
        <label for="foto" class="block text-sm font-medium text-gray-700 mb-2">
          Foto
        </label>
        <input type="file" id="foto" (change)="onFileSelected($event)" accept="image/*" class="block w-full text-sm text-gray-500
            file:mr-4 file:py-2 file:px-4
            file:rounded-md file:border-0
            file:text-sm file:font-semibold
            file:bg-blue-50 file:text-blue-700
            hover:file:bg-blue-100" />
        <small class="text-gray-500">Selecciona una imagen para el autor</small>

        <div *ngIf="selectedAutor?.foto_url" class="mt-3">
          <p class="text-xs text-gray-500 mb-2">Foto actual:</p>
          <img [src]="selectedAutor?.foto_url || ''" alt="Foto actual" class="h-20 w-20 object-cover rounded" />
        </div>
      </div>

      <div class="flex justify-end gap-3 pt-4">
        <p-button label="Cancelar" (onClick)="cancelEdit()" [text]="true" severity="secondary">
        </p-button>
        <p-button label="{{ selectedAutor ? 'Actualizar' : 'Crear' }}" type="submit" [loading]="isLoading"
          icon="pi pi-check" severity="primary">
        </p-button>
      </div>
    </form>
  </p-dialog>
</div>